{"version":3,"sources":["../src/grading_popup_cm.js"],"names":["define","$","notification","str","ajax","log","templates","ModalFactory","ModalEvents","GradingPopupCm","regionSelector","userCompetencySelector","contextid","_regionSelector","_userCompetencySelector","on","_handleClick","bind","prototype","e","cell","target","closest","competencyId","data","cmId","userId","debug","requests","call","methodname","args","userid","competencyid","cmid","when","apply","then","context","_contextLoaded","catch","exception","self","displayuser","get_string","done","title","create","type","types","DEFAULT","body","render","large","modal","popup","getRoot","hidden","_refresh","show","fail","region","destroy","_pageContextLoaded","html","js","replaceNode"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to enable inline editing of a comptency grade for a course module.\n *\n * @module     report_cmcompetency/grading_popup_cm\n * @copyright  2019 Université de Montréal\n * @author     Marie-Eve Lévesque <marie-eve.levesque.8@umontreal.ca>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/notification', 'core/str', 'core/ajax', 'core/log', 'core/templates',\n    'core/modal_factory', 'core/modal_events'],\n    function($, notification, str, ajax, log, templates, ModalFactory, ModalEvents) {\n\n        /**\n         * GradingPopupCm\n         *\n         * @param {String} regionSelector The regionSelector\n         * @param {String} userCompetencySelector The userCompetencySelector\n         * @param {Number} contextid The context id\n         */\n        var GradingPopupCm = function(regionSelector, userCompetencySelector, contextid) {\n            this._regionSelector = regionSelector;\n            this._userCompetencySelector = userCompetencySelector;\n            this.contextid = contextid;\n            $(this._regionSelector).on('click', this._userCompetencySelector, this._handleClick.bind(this));\n        };\n\n        /**\n         * Get the data from the clicked cell and open the popup.\n         *\n         * @method _handleClick\n         * @param {Event} e The event\n         */\n        GradingPopupCm.prototype._handleClick = function(e) {\n            var cell = $(e.target).closest(this._userCompetencySelector);\n            var competencyId = $(cell).data('competencyid');\n            var cmId = $(cell).data('cmid');\n            var userId = $(cell).data('userid');\n\n            log.debug('Clicked on cell: competencyId=' + competencyId + ', cmId=' + cmId + ', userId=' + userId);\n\n            var requests = ajax.call([{\n                methodname: 'tool_cmcompetency_data_for_user_competency_summary_in_coursemodule',\n                args: {userid: userId, competencyid: competencyId, cmid: cmId},\n            }, {\n                methodname: 'tool_cmcompetency_user_competency_viewed_in_coursemodule',\n                args: {userid: userId, competencyid: competencyId, cmid: cmId},\n            }]);\n\n            $.when.apply($, requests).then(function(context) {\n                this._contextLoaded.bind(this)(context, cell);\n                return;\n            }.bind(this)).catch(notification.exception);\n        };\n\n        /**\n         * We loaded the context, now render the template.\n         *\n         * @method _contextLoaded\n         * @param {Object} context\n         * @param {Object} cell\n         */\n        GradingPopupCm.prototype._contextLoaded = function(context, cell) {\n            var self = this;\n            // We have to display user info in popup.\n            context.displayuser = true;\n            context.contextid = self.contextid;\n            return str.get_string('usercompetencysummary', 'report_competency').done(function(title) {\n                    return ModalFactory.create({\n                        type: ModalFactory.types.DEFAULT,\n                        title: title,\n                        body: templates.render('report_cmcompetency/user_competency_summary_in_coursemodule', context),\n                        large: true\n                    }, cell).done(function(modal) {\n                        // Keep a reference to the modal.\n                        self.popup = modal;\n                        self.popup.getRoot().on(ModalEvents.hidden, self._refresh.bind(self));\n                        self.popup.show();\n                    }.bind(this));\n            }).fail(notification.exception);\n\n        };\n\n        /**\n         * Get the data to refresh the page when the popup is closed.\n         *\n         * @method _refresh\n         */\n        GradingPopupCm.prototype._refresh = function() {\n            var region = $(this._regionSelector);\n            var cmId = region.data('cmid');\n            var userId = region.data('userid');\n            this.popup.destroy();\n            ajax.call([{\n                methodname: 'report_cmcompetency_data_for_report',\n                args: {cmid: cmId, userid: userId},\n                done: this._pageContextLoaded.bind(this),\n                fail: notification.exception\n            }]);\n        };\n\n        /**\n         * We loaded the context, now render the template (refresh the page when the popup is closed).\n         *\n         * @method _pageContextLoaded\n         * @param {Object} context\n         */\n        GradingPopupCm.prototype._pageContextLoaded = function(context) {\n            var self = this;\n            context.contextid = self.contextid;\n            templates.render('report_cmcompetency/report', context).done(function(html, js) {\n                templates.replaceNode(self._regionSelector, html, js);\n            }).fail(notification.exception);\n        };\n\n        /** @type {String} The selector for the region with the user competencies */\n        GradingPopupCm.prototype._regionSelector = null;\n\n        /** @type {String} The selector for the region with a single user competencies */\n        GradingPopupCm.prototype._userCompetencySelector = null;\n\n        /** @type {Number} The context id */\n        GradingPopupCm.prototype.contextid = null;\n\n        /** @var {Dialogue} popup  The popup window (Dialogue). */\n        GradingPopupCm.prototype.popup = null;\n\n        return GradingPopupCm;\n    });\n"],"file":"grading_popup_cm.min.js"}